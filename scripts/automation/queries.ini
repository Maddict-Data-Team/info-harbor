[Setup]
radius_query = SELECT 
    distinct(radius)
    FROM {project}.{footfall_dataset}.{codename}_pois

query_metadata = Select date(start_date) as last_update,CURRENT_DATE as today, country,type
    FROM {project}.{metadata_dataset}.{campaign_tracker_table}
    WHERE code_name = {codename}

[Retail Intelligence Dashboard]
queries = visitors,behavior,home_graph,travel_distance,travel_distance_km,dwell_time,loyalist_vs_onetime,device_os,visitors_in_competitors,employee_vs_visitor,socioeco
queries_union_countries = visitors,behavior
visitors=SELECT
    ls.did,
    ls.Local_Day,
    ls.Timestamp,
    ls.Local_Hour,
    ls.Longitude,
    ls.latitude,
    ls.Local_time,
    poi.POI_ID,
    0 as Data_filter,
    0 as Device_os_id,
    ls.Device_OS
    FROM
    `{project}.{location_signals_dataset}.{country}_Data` AS ls
    JOIN
    `{project}.{footfall_dataset}.{codename}_pois` AS poi
    ON
    ST_DISTANCE(ST_GEOGPOINT(ls.Longitude,ls.latitude),ST_GEOGPOINT(poi.longitude,poi.latitude))<poi.radius
    WHERE
    ls.timestamp Between "{last_update}" AND "{today}"
    
device_os = Select distinct did, Device_os_id
    from {project}.{location_signals_dataset}.{device_os_mapping_table}
    where did in (SELECT DID from {project}.{footfall_dataset}.{codename}_visitors)

home_graph = Select * 
    from `{project}.{hwg_dataset}.{hwg_table}`
    where did in (select distinct(did) from {project}.{footfall_dataset}.{codename}_visitors)

behavior = Select * 
    from `{project}.POI_DB_{country_beh}.Behavioral_{country}_RAW_Cumulative`
    where did in (select distinct(did) from {project}.{footfall_dataset}.{codename}_visitors)

travel_distance = SELECT
    distinct(hg.DID),
    ST_DISTANCE(ST_GEOGPOINT(vis.longitude,vis.latitude),ST_GEOGPOINT(hg.long1,hg.lat1)) AS travel_distance
    FROM `{project}.{footfall_dataset}.{codename}_home_graph` AS hg
    JOIN `{project}.{footfall_dataset}.{codename}_visitors` AS vis
    ON vis.did = hg.did
    
loyalist_vs_onetime=SELECT
     did,
     poi_id,
     "Loyalists" AS Type
    FROM (
     SELECT
      COUNT(DISTINCT(local_day)) AS days_visited,
      did,
      poi_id
     FROM
      `{project}.{footfall_dataset}.{codename}_visitors`
     GROUP BY
      did,
      poi_id)
    WHERE
     days_visited > 1
    GROUP BY
    did,
     poi_id
    UNION ALL
    SELECT
     did,
     poi_id,
     "One time" AS Type
    FROM (
     SELECT
      COUNT(DISTINCT(local_day)) AS days_visited,
      did,
      poi_id
     FROM
      `{project}.{footfall_dataset}.{codename}_visitors`
     GROUP BY
      did,
      poi_id)
    WHERE
     days_visited = 1
    GROUP BY
    did,
     poi_id

employee_vs_visitor = SELECT
    did,
    "Employee" as type,
    poi_id
    FROM (
    SELECT
    COUNT(DISTINCT(local_day)) AS days,
    did,
    poi_id
    FROM
    `{project}.{footfall_dataset}.{codename}_visitors`
    GROUP BY
    did,
    poi_id
    HAVING
    days >=15 )
    GROUP BY
    did,
    poi_id
    UNION ALL
    SELECT
    did,
    "Visitors" as type,
    poi_id
    FROM (
    SELECT
    COUNT(DISTINCT(local_day)) AS days,
    did,
    poi_id
    FROM
    `{project}.{footfall_dataset}.{codename}_visitors`
    GROUP BY
    did,
    poi_id
    HAVING
    days <15 )
    GROUP BY
    did,
    poi_id

socioeco = SELECT
    distinct(did),
    1 AS Economic_Status,
    FROM
    `{project}.{footfall_dataset}.{codename}_visitors` AS VIS
    WHERE
    did IN (
    SELECT
    did
    FROM
    `{project}.{footfall_dataset}.{codename}_Behavior` AS BEH
    JOIN 
        `{project}.{footfall_dataset}.{lookup_behavior_table}` as IL
        on BEH.Behavior_ID = IL.Behavior_ID
    WHERE 
    IL.Behavior_Name = 'HNWI')

    UNION ALL

    SELECT
    distinct(did),
    2 AS Economic_Status,
    FROM
    `{project}.{footfall_dataset}.{codename}_visitors` AS VIS
    WHERE
    did IN (
    SELECT
    did
    FROM
    `{project}.{footfall_dataset}.{codename}_Behavior` AS BEH
    JOIN 
        `{project}.{footfall_dataset}.Lookup_Behavior` as IL
        on BEH.Behavior_ID = IL.Behavior_ID
    WHERE
    IL.Behavior_Name = 'Luxurious Lifestyle')

    and did NOT IN (
    SELECT
    did
    FROM
    `{project}.{footfall_dataset}.{codename}_Behavior` AS BEH
    JOIN 
        `{project}.{footfall_dataset}.Lookup_Behavior` as IL
        on BEH.Behavior_ID = IL.Behavior_ID
    WHERE
    IL.Behavior_Name = 'HNWI')

    UNION ALL

    SELECT 
    distinct(did), 
    3 AS Economic_Status,
    FROM
    `{project}.{footfall_dataset}.{codename}_visitors` AS VIS
    WHERE
    did NOT IN (
    SELECT
    did
    FROM
    `{project}.{footfall_dataset}.{codename}_Behavior` AS BEH
    JOIN 
        `{project}.{footfall_dataset}.Lookup_Behavior` as IL
        on BEH.Behavior_ID = IL.Behavior_ID
    WHERE
    IL.Behavior_Name in ('Luxurious Lifestyle','HNWI'))


dwell_time = SELECT
    did ,
    (MAX(local_hour)-MIN(local_hour)) AS dwell_time,
    poi_id,
    local_day
    FROM
    `{project}.{footfall_dataset}.{codename}_visitors`
    GROUP BY
    local_day,
    did,
    poi_id
    HAVING
    dwell_time < 6 

travel_distance_km = SELECT 
    distinct(did),
    CASE
    WHEN travel_distance_km BETWEEN 0 AND 5 THEN '0 - 5 km'
    WHEN travel_distance_km BETWEEN 5 AND 10 THEN '5 - 10 km'
    WHEN travel_distance_km BETWEEN 10 AND 15 THEN '10 - 15 km'
    WHEN travel_distance_km BETWEEN 15 AND 20 THEN '15 - 20 km'
    WHEN travel_distance_km BETWEEN 20 AND 25 THEN '20 - 25 km'
    WHEN travel_distance_km BETWEEN 25 AND 30 THEN '25 - 30 km'
    WHEN travel_distance_km BETWEEN 30 AND 35 THEN '30 - 35 km'
    WHEN travel_distance_km BETWEEN 35 AND 40 THEN '35 - 40 km'
    WHEN travel_distance_km BETWEEN 40 AND 45 THEN '40 - 45 km'
    WHEN travel_distance_km BETWEEN 45 AND 50 THEN '45 - 50 km'
    ELSE '50+ km'
    END AS distance_category

    FROM (
    SELECT 
        did,
    (travel_distance / 1000) AS travel_distance_km

    FROM `{project}.{footfall_dataset}.{codename}_travel_distance`
    ) AS subquery

visitors_in_competitors = Select distinct(yl.did),com.poi_ID 
    from `{project}.{footfall_dataset}.{codename}_visitors` as yl 
    join (
    
    Select did,poi_id from `{project}.{footfall_dataset}.{codename}_visitors`  as vis
    join `{project}.{footfall_dataset}.{codename}_pois` as poi
    on vis.poi_id = poi.poi_id 
    where poi.data_filter = 2) as com 
    on yl.did = com.did
    join `{project}.{footfall_dataset}.{codename}_pois` as poi
    on yl.poi_id = poi.poi_id
    where poi.data_filter = 1 

    UNION ALL

    Select distinct(yl.did),yl.poi_ID 
    from `{project}.{footfall_dataset}.{codename}_visitors` as yl 
    join (Select did,poi_id from `{project}.{footfall_dataset}.{codename}_visitors`  as vis
    join `{project}.{footfall_dataset}.{codename}_pois` as poi
    on vis.poi_id = poi.poi_id 
    where poi.data_filter = 2) as com
    on yl.did = com.did
    join `{project}.{footfall_dataset}.{codename}_pois` as poi
    on yl.poi_id = poi.poi_id
    where poi.data_filter = 1 

[Footfall Dashboard]
queries = visitors_campaign,footfall


[Placelift Report]
queries = visitors,footfall

